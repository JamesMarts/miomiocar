name: Flutter CI/CD

# 触发条件
on:
  # 推送到主要分支时触发
  push:
    branches: [ main, develop, master ]
  # PR到主要分支时触发
  pull_request:
    branches: [ main, develop, master ]
  # 支持手动触发
  workflow_dispatch:
    inputs:
      environment:
        description: '构建环境'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

# 环境变量
env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'

# 任务
jobs:
  # 代码检查
  analyze:
    name: 代码分析
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      - name: 代码分析
        run: flutter analyze
      
      - name: 格式检查
        run: flutter format --set-exit-if-changed lib/ test/
  
  # 测试
  test:
    name: 单元测试
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: analyze
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      - name: 运行测试
        run: flutter test --coverage
      
      - name: 上传测试覆盖率
        uses: codecov/codecov-action@v3
        if: success()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
  
  # Android 打包
  build-android:
    name: 构建 Android APK/AAB
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 确定构建环境
      - name: 设置构建环境
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 APK
      - name: 构建 APK
        run: flutter build apk --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 构建 App Bundle (可选，用于 Google Play)
      - name: 构建 App Bundle
        run: flutter build appbundle --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 上传 APK
      - name: 上传 APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ env.ENVIRONMENT }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
      
      # 上传 App Bundle
      - name: 上传 App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ env.ENVIRONMENT }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
  
  # iOS 打包（需要 macOS）
  build-ios:
    name: 构建 iOS IPA
    runs-on: macos-latest
    timeout-minutes: 45
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 设置构建环境
      - name: 设置构建环境
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 iOS (无签名版本，用于测试)
      - name: 构建 iOS
        run: |
          flutter build ios --release --no-codesign --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 注意：实际的 IPA 打包需要配置签名证书
      # 这里只是演示构建流程
      - name: 上传 iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ env.ENVIRONMENT }}
          path: build/ios/iphoneos/
          retention-days: 30
  
  # Web 打包
  build-web:
    name: 构建 Web
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 设置构建环境
      - name: 设置构建环境
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 Web
      - name: 构建 Web
        run: flutter build web --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 上传 Web Build
      - name: 上传 Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ env.ENVIRONMENT }}
          path: build/web/
          retention-days: 30
      
      # 可选：部署到 GitHub Pages
      # - name: 部署到 GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   if: github.ref == 'refs/heads/main'
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./build/web
  
  # Windows 打包
  build-windows:
    name: 构建 Windows
    runs-on: windows-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 设置构建环境
      - name: 设置构建环境
        id: set-env
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 Windows
      - name: 构建 Windows
        run: flutter build windows --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 打包 Windows 应用
      - name: 打包 Windows 应用
        shell: bash
        run: |
          cd build/windows/x64/runner/Release
          7z a -r ../../../../../flutter_demo_windows_${{ env.ENVIRONMENT }}.zip *
      
      # 上传 Windows Build
      - name: 上传 Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ env.ENVIRONMENT }}
          path: flutter_demo_windows_${{ env.ENVIRONMENT }}.zip
          retention-days: 30
  
  # macOS 打包
  build-macos:
    name: 构建 macOS
    runs-on: macos-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 设置构建环境
      - name: 设置构建环境
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 macOS
      - name: 构建 macOS
        run: flutter build macos --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 打包 macOS 应用
      - name: 打包 macOS 应用
        run: |
          cd build/macos/Build/Products/Release
          zip -r -y ../../../../../flutter_demo_macos_${{ env.ENVIRONMENT }}.zip flutter_demo.app
      
      # 上传 macOS Build
      - name: 上传 macOS Build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ env.ENVIRONMENT }}
          path: flutter_demo_macos_${{ env.ENVIRONMENT }}.zip
          retention-days: 30
  
  # Linux 打包
  build-linux:
    name: 构建 Linux
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
      
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: 获取依赖
        run: flutter pub get
      
      - name: 代码生成
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # 设置构建环境
      - name: 设置构建环境
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi
      
      # 构建 Linux
      - name: 构建 Linux
        run: flutter build linux --release --dart-define=ENVIRONMENT=${{ env.ENVIRONMENT }}
      
      # 打包 Linux 应用
      - name: 打包 Linux 应用
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../flutter_demo_linux_${{ env.ENVIRONMENT }}.tar.gz *
      
      # 上传 Linux Build
      - name: 上传 Linux Build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-${{ env.ENVIRONMENT }}
          path: flutter_demo_linux_${{ env.ENVIRONMENT }}.tar.gz
          retention-days: 30
  
  # 创建发布（仅在推送到 main/master 时）
  release:
    name: 创建 Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-web, build-windows, build-macos, build-linux]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      # 下载所有构建产物
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      # 获取版本号
      - name: 获取版本号
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=v$VERSION" >> $GITHUB_ENV
      
      # 创建 Release
      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/android-apk-production/*.apk
            artifacts/android-aab-production/*.aab
            artifacts/windows-build-production/*.zip
            artifacts/macos-build-production/*.zip
            artifacts/linux-build-production/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

